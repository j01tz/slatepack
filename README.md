# slatepack
This is a test repo to experiment with a standard for generating armored slates for Grin transactions.

It should be able to:

- [x]  Serialize armored strings from `grin-wallet` prepared slate json strings and file bytes

- [x]  Deserialize armor prepared by `slatepack` as bytes or json string for use in `grin-wallet`

### How slatepack armoring works when serializing with `string_to_armor()` or `bytes_to_armor()`
1. If a json string is passed it is serialized as bytes
2. An error checking code is generated by taking the first four bytes of a double sha256 hash of the slate binary
3. Error checking code bytes and slate bytes are concatenated
4. Output from step 3 is base58 encoded
5. Output from step 4 is formatted into 15 character words for readability
6. Output from step 5 is framed with a header and footer containing human and machine readable characters, notably a period at the end of the header, a period at the start of the footer and a period at the end of the footer.

### How slatepack armoring works when deserializing with `armor_to_string()` or `armor_to_bytes()`
1. Armor string is deserialized into bytes
2. Bytes are consumed until the first byte representing a "period" is reached- this is the framing header
3. Framing header is validated
4. Remaining bytes after the framing header are consumed until the next byte representing a "period" is reached- this is the slate body
5. Any remaining bytes until the next "period" byte are the framing footer
6. Framing footer is validated
7. Slate body bytes are sanitized for whitespace characters
8. Slate body bytes are decoded with base58
9. First four bytes of the result are the error check code
10. Remaining slate body bytes are twice hashed with SHA256 and the first four bytes are compared with the error check code from the previous step for validation
11. If the validation is successful the slate body bytes should match those from the original slate before it was armored
12. Returned value can then be written to a file when using `armor_to_bytes()` or ready for transport as a json string when using `armor_to_string()` for use in `grin-wallet`

#### V4 initial slate json string:
```
{\n  \"ver\": \"4.3\",\n  \"sta\": \"S1\",\n  \"id\": \"mavTAjNm4NVztDwh4gdSrQ\",\n  \"amt\": \"1000000000\",\n  \"fee\": \"8000000\",\n  \"sigs\": [\n    {\n      \"excess\": \"02ef37e5552a112f829e292bb031b484aaba53836cd6415aacbdb8d3d2b0c4bb9a\",\n      \"nonce\": \"03c78da42179b80bd123f5a39f5f04e2a918679da09cad5558ebbe20953a82883e\"\n    }\n  ]\n}\n
```

#### V4 initial slate armored with slatepack:
```
BEGIN SLATEPACK. 2xfX9bS82gxJ6jN D6X4X843wrT84DT FkstYawTtacDqeU HybZLwcF26YXCix bmpTcw3hii6BF4x axfussSBrZq7xMQ P1rbw3GpebXkMeY i7aSjRZgxqDJwzt MyGqBauGHxEFZNg FeEbVFsqXaKkKwK PQdxrpKutVmJV67 pbY4nbeZgPtRaZj QZL61Wj7iGqKBuu tDvEwUBsuhb9GRf 1MK3jegnbKG5JJr QVrYignWoZrpXUx PiDobVMLh7RTRrz T6GNKJftiwJ5gup f7T69mFG9H8JqCG A4i5ogfcHhfgg5b 2AzBJA49nh39Pyh zotpGBj7a7RK4Kr bWqksP7iTxvfdUB zVwinrRjLeryvF7 uroTKm514ZDDrKf ZbyncaZXcFGYHWM tWp5ccsjjtM1JqB adragavjHQyjqkU 2JH9YnoRkx2AyuU qvn7nnb4fMTAVSw sbAPwBTua7njNht nhzRqtdHTr9KM9q eXHDN9iascu. END SLATEPACK.
```

### Example use:
- Copy slate json into file named `v4_test.slate`

```
{
  "ver": "4.3",
  "sta": "S1",
  "id": "mavTAjNm4NVztDwh4gdSrQ",
  "amt": "1000000000",
  "fee": "8000000",
  "sigs": [
    {
      "excess": "02ef37e5552a112f829e292bb031b484aaba53836cd6415aacbdb8d3d2b0c4bb9a",
      "nonce": "03c78da42179b80bd123f5a39f5f04e2a918679da09cad5558ebbe20953a82883e"
    }
  ]
}

```

- Add slatepack dependency to `Cargo.toml`

```
[dependencies]
slatepack = { git = "https://github.com/j01tz/slatepack" }
```

```
use slatepack;

let slate = include_str!("v4_test.slate");
let armored_slate = slatepack::string_to_armor(&slate).unwrap();
println!("{:?}", armored_slate);
```

### TODO
- [ ] Add support for multiple slatepack messages for very big slates
- [ ] Add slate type to framing for human convenience: INITIAL, RESPONSE, INVOICE
- [ ] Make more idiomatic

This should not be used for any real transactions. It is for educational purposes to visualize and experiment with the armored slate string format.
